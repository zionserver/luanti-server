name: Continuous Minetest Server Release

on:
  push:
    branches: [main]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      env:
        LANG: C.UTF-8
        DEBIAN_FRONTEND: noninteractive

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        apt-get update
        apt-get install -y --no-install-recommends \
          build-essential cmake ninja-build git \
          libsqlite3-dev libzstd-dev libcurl4-openssl-dev \
          libncurses-dev libgmp-dev \
          libjsoncpp-dev libssl-dev zlib1g-dev \
          ca-certificates wget binutils dpkg-dev \
          gettext pkg-config
        
        apt-get clean
        rm -rf /var/lib/apt/lists/*

    - name: Build Minetest Server
      run: chmod +x build.sh && ./build.sh

    - name: Get commit details
      id: commit
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "sha_short=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Rename package
      run: |
        cd minetest/build
        mv minetest-server_5.12.0_bookworm_amd64.deb "minetest-server_${{ steps.commit.outputs.date }}_${{ steps.commit.outputs.sha_short }}_bookworm_amd64.deb"

    - name: Create Continuous Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Minetest Server Continuous Build"
        tag_name: "continuous"
        body: "Latest server build from main branch"
        prerelease: true
        files: |
          minetest/build/minetest-server_*.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}